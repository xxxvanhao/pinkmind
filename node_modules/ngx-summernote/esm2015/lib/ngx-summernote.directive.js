/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { HttpClient } from '@angular/common/http';
import { Directive, ElementRef, EventEmitter, forwardRef, Input, NgZone, Output, } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { of, throwError } from 'rxjs';
import { catchError, map } from 'rxjs/operators';
export class NgxSummernoteDirective {
    /**
     * @param {?} el
     * @param {?} zone
     * @param {?} http
     */
    constructor(el, zone, http) {
        this.zone = zone;
        this.http = http;
        // summernoteModel directive as output: update model if editor contentChanged
        this.summernoteModelChange = new EventEmitter();
        this.imageUpload = new EventEmitter();
        // summernoteInit directive as output: send manual editor initialization
        this.summernoteInit = new EventEmitter();
        this.blur = new EventEmitter();
        this._options = {
            immediateAngularModelUpdate: false,
            angularIgnoreAttrs: null,
            placeholder: '',
            tabsize: 2,
            height: 100,
            uploadImagePath: '',
            toolbar: [
                // [groupName, [list of button]]
                ['misc', ['codeview', 'undo', 'redo', 'codeBlock']],
                // ['style', ['bold', 'italic', 'underline', 'clear']],
                ['font', ['bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript', 'clear']],
                ['fontsize', ['fontname', 'fontsize', 'color']],
                ['para', ['style0', 'ul', 'ol', 'paragraph', 'height']],
                ['insert', ['table', 'picture', 'link', 'video', 'hr']],
            ],
            fontNames: ['Helvetica', 'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Roboto', 'Times'],
            callbacks: {
                onImageUpload: (files) => this.uploadImage(files)
            },
            buttons: {
                codeBlock: this.codeBlockButton()
            }
        };
        this.SPECIAL_TAGS = ['img', 'button', 'input', 'a'];
        this.INNER_HTML_ATTR = 'innerHTML';
        this._oldModel = null;
        // Begin ControlValueAccesor methods.
        this.onChange = (_) => { };
        this.onTouched = () => { };
        /** @type {?} */
        const element = el.nativeElement;
        // check if the element is a special tag
        if (this.SPECIAL_TAGS.indexOf(element.tagName.toLowerCase()) !== -1) {
            this._hasSpecialTag = true;
        }
        // jquery wrap and store element
        this._$element = ((/** @type {?} */ ($(element))));
        this.zone = zone;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    set ngxSummernote(options) {
        if (options.buttons) {
            Object.assign(options.buttons, this._options.buttons);
        }
        this._options = Object.assign(this._options, options);
    }
    // summernoteModel directive as input: store initial editor content
    /**
     * @param {?} content
     * @return {?}
     */
    set summernoteModel(content) {
        this.updateEditor(content);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this._options.toolbar;
        // check if output summernoteInit is present. Maybe observers is private and
        // should not be used?? TODO how to better test that an output directive is present.
        if (!this.summernoteInit.observers.length) {
            this.createEditor();
        }
        else {
            // TODO not sure it works now...
            this.generateManualController();
        }
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (this._editorInitialized && changes) {
            if (changes.ngxSummernoteDisabled && !changes.ngxSummernoteDisabled.firstChange &&
                changes.ngxSummernoteDisabled.currentValue !== changes.ngxSummernoteDisabled.previousValue) {
                if (changes.ngxSummernoteDisabled.currentValue) {
                    this._$element.summernote('disable');
                }
                else {
                    this._$element.summernote('enable');
                }
            }
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroyEditor();
    }
    // Form model content changed.
    /**
     * @param {?} content
     * @return {?}
     */
    writeValue(content) {
        this.updateEditor(content);
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnChange(fn) { this.onChange = fn; }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnTouched(fn) { this.onTouched = fn; }
    // Update editor with model contents.
    /**
     * @private
     * @param {?} content
     * @return {?}
     */
    updateEditor(content) {
        if (JSON.stringify(this._oldModel) === JSON.stringify(content)) {
            return;
        }
        this._oldModel = content;
        this._$element.html(content);
        if (this._editorInitialized) {
            this._$element.summernote('code', content);
        }
        else {
            this._$element.html(content);
        }
    }
    // update model if editor contentChanged
    /**
     * @private
     * @param {?=} content
     * @return {?}
     */
    updateModel(content) {
        // console.log("update model", content)
        this.zone.run(() => {
            /** @type {?} */
            let modelContent = null;
            if (this._hasSpecialTag) {
                /** @type {?} */
                const attributeNodes = this._$element[0].attributes;
                /** @type {?} */
                const attrs = {};
                for (let i = 0; i < attributeNodes.length; i++) {
                    /** @type {?} */
                    const attrName = attributeNodes[i].name;
                    if (this._options.angularIgnoreAttrs && this._options.angularIgnoreAttrs.indexOf(attrName) !== -1) {
                        continue;
                    }
                    attrs[attrName] = attributeNodes[i].value;
                }
                if (this._$element[0].innerHTML) {
                    attrs[this.INNER_HTML_ATTR] = this._$element[0].innerHTML;
                }
                modelContent = attrs;
            }
            else {
                /** @type {?} */
                const returnedHtml = content || '';
                if (typeof returnedHtml === 'string') {
                    modelContent = returnedHtml;
                }
            }
            this._oldModel = modelContent;
            // Update summernoteModel
            this.summernoteModelChange.emit(modelContent);
            // Update form model.
            this.onChange(content);
        });
    }
    /**
     * @private
     * @return {?}
     */
    initListeners() {
        /** @type {?} */
        const self = this;
        if (!this._$element) {
            return;
        }
        this._$element.on('summernote.init', function () {
            setTimeout(function () {
                self.updateModel();
            }, 0);
        });
        this._$element.on('summernote.change', function (event, contents, $editable) {
            setTimeout(function () {
                self.updateModel(contents);
            }, 0);
        });
        this._$element.on('summernote.blur', function () {
            setTimeout(function () {
                self.onTouched();
                self.blur.emit();
            }, 0);
        });
        if (this._options.immediateAngularModelUpdate) {
            this._editor.on('keyup', function () {
                setTimeout(function () {
                    self.updateModel();
                }, 0);
            });
        }
    }
    /**
     * @private
     * @return {?}
     */
    createEditor() {
        if (this._editorInitialized) {
            return;
        }
        this.setContent(true);
        // this.initListeners(); // issue #31 
        // init editor
        this.zone.runOutsideAngular(() => {
            this._editor = this._$element.summernote(this._options).data('summernote').$note;
            this.initListeners(); // issue #31
            if (this.ngxSummernoteDisabled) {
                this._$element.summernote('disable');
            }
        });
        this._editorInitialized = true;
    }
    /**
     * @private
     * @return {?}
     */
    setHtml() {
        this._$element.summernote('code', this._model || '', true);
    }
    /**
     * @private
     * @param {?=} firstTime
     * @return {?}
     */
    setContent(firstTime = false) {
        // console.log("set content", firstTime, this._oldModel, this._model)
        /** @type {?} */
        const self = this;
        // Set initial content
        if (this._model || this._model === '') {
            this._oldModel = this._model;
            if (this._hasSpecialTag) {
                /** @type {?} */
                const tags = this._model;
                // add tags on element
                if (tags) {
                    for (const attr in tags) {
                        if (tags.hasOwnProperty(attr) && attr !== this.INNER_HTML_ATTR) {
                            this._$element.attr(attr, tags[attr]);
                        }
                    }
                    if (tags.hasOwnProperty(this.INNER_HTML_ATTR)) {
                        this._$element[0].innerHTML = tags[this.INNER_HTML_ATTR];
                    }
                }
            }
            else {
                self.setHtml();
            }
        }
    }
    /**
     * @private
     * @return {?}
     */
    destroyEditor() {
        if (this._editorInitialized) {
            this._editor.off('keyup');
            this._$element.summernote('destroy'); // TODO not sure it works now...
            this._editorInitialized = false;
        }
    }
    /**
     * @private
     * @return {?}
     */
    getEditor() {
        if (this._$element) {
            return this._$element.summernote.bind(this._$element);
        }
        return null;
    }
    // send manual editor initialization
    // TODO not sure it works now...
    /**
     * @private
     * @return {?}
     */
    generateManualController() {
        /** @type {?} */
        const controls = {
            initialize: this.createEditor.bind(this),
            destroy: this.destroyEditor.bind(this),
            getEditor: this.getEditor.bind(this),
        };
        this.summernoteInit.emit(controls);
    }
    /**
     * @private
     * @param {?} files
     * @return {?}
     */
    uploadImage(files) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const data = new FormData();
            this.imageUpload.emit({ uploading: true });
            data.append('image', files[0]);
            if (this._options.uploadImagePath) {
                this.http.post(this._options.uploadImagePath, data)
                    .pipe(map((response) => response && typeof response.path === 'string' && response.path), catchError(e => {
                    throwError('An error occured while uploading' + e);
                    return of('');
                }))
                    .subscribe(dataIn => {
                    if (dataIn) {
                        this._$element.summernote('insertImage', dataIn);
                        this.imageUpload.emit({ uploading: false });
                    }
                    else {
                        this.insertFromDataURL(files);
                    }
                }, (e) => {
                    this.insertFromDataURL(files);
                });
            }
            else {
                this.insertFromDataURL(files);
            }
        });
    }
    /**
     * @param {?} files
     * @return {?}
     */
    insertFromDataURL(files) {
        /** @type {?} */
        const reader = new FileReader();
        reader.readAsDataURL(files[0]);
        reader.onload = () => {
            this._$element.summernote('insertImage', reader.result);
            this.imageUpload.emit({ uploading: false, encoding: 'base64' });
        };
        reader.onerror = error => console.error(error);
    }
    /**
     * @private
     * @return {?}
     */
    codeBlockButton() {
        return function (context) {
            /** @type {?} */
            const ui = $.summernote.ui;
            // create button
            /** @type {?} */
            const button = ui.button({
                contents: 'Code block',
                tooltip: 'Add raw code',
                click: function () {
                    /** @type {?} */
                    let selectedText = null;
                    // The below code will copy the selected block and add it into our code=block
                    if (window.getSelection) {
                        selectedText = window.getSelection().toString().replace(/^\s+|\s+$/g, '');
                    }
                    /** @type {?} */
                    const codeText = selectedText ? selectedText : `Place your code here.`;
                    /** @type {?} */
                    const codeBlock = `<pre class="code-block" style="font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 12px; padding: 14px 12px; margin-bottom: 10px; line-height: 1.42857; word-break: break-all; overflow-wrap: break-word; background-color: rgb(250, 251, 253); border: 1px solid rgb(234, 236, 240); border-radius: 4px; color: #60a0b0"><span style="white-space: pre-wrap;">${codeText}</span></pre>`;
                    context.invoke('editor.pasteHTML', codeBlock);
                }
            });
            return button.render(); // return button as jquery object
        };
    }
}
NgxSummernoteDirective.decorators = [
    { type: Directive, args: [{
                // tslint:disable-next-line:directive-selector
                selector: '[ngxSummernote]',
                providers: [{
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(() => NgxSummernoteDirective),
                        multi: true
                    }]
            },] },
];
/** @nocollapse */
NgxSummernoteDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: NgZone },
    { type: HttpClient }
];
NgxSummernoteDirective.propDecorators = {
    ngxSummernote: [{ type: Input }],
    summernoteModel: [{ type: Input }],
    summernoteModelChange: [{ type: Output }],
    imageUpload: [{ type: Output }],
    summernoteInit: [{ type: Output }],
    blur: [{ type: Output }],
    ngxSummernoteDisabled: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    NgxSummernoteDirective.prototype.summernoteModelChange;
    /** @type {?} */
    NgxSummernoteDirective.prototype.imageUpload;
    /** @type {?} */
    NgxSummernoteDirective.prototype.summernoteInit;
    /** @type {?} */
    NgxSummernoteDirective.prototype.blur;
    /** @type {?} */
    NgxSummernoteDirective.prototype.ngxSummernoteDisabled;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype._options;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype.SPECIAL_TAGS;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype.INNER_HTML_ATTR;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype._hasSpecialTag;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype._$element;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype._editor;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype._model;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype._oldModel;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype._editorInitialized;
    /** @type {?} */
    NgxSummernoteDirective.prototype.onChange;
    /** @type {?} */
    NgxSummernoteDirective.prototype.onTouched;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    NgxSummernoteDirective.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXN1bW1lcm5vdGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXN1bW1lcm5vdGUvIiwic291cmNlcyI6WyJsaWIvbmd4LXN1bW1lcm5vdGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFDSCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFJTixNQUFNLEdBQ1QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUF3QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFhakQsTUFBTSxPQUFPLHNCQUFzQjs7Ozs7O0lBeUQvQixZQUFZLEVBQWMsRUFBVSxJQUFZLEVBQVUsSUFBZ0I7UUFBdEMsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFVLFNBQUksR0FBSixJQUFJLENBQVk7O1FBNUNoRSwwQkFBcUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNuRSxnQkFBVyxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDOztRQUd6RCxtQkFBYyxHQUF5QixJQUFJLFlBQVksRUFBVSxDQUFDO1FBRWxFLFNBQUksR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUlwRCxhQUFRLEdBQVE7WUFDcEIsMkJBQTJCLEVBQUUsS0FBSztZQUNsQyxrQkFBa0IsRUFBRSxJQUFJO1lBQ3hCLFdBQVcsRUFBRSxFQUFFO1lBQ2YsT0FBTyxFQUFFLENBQUM7WUFDVixNQUFNLEVBQUUsR0FBRztZQUNYLGVBQWUsRUFBRSxFQUFFO1lBQ25CLE9BQU8sRUFBRTtnQkFDTCxnQ0FBZ0M7Z0JBQ2hDLENBQUMsTUFBTSxFQUFFLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQ25ELHVEQUF1RDtnQkFDdkQsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFDL0YsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUMvQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDdkQsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDMUQ7WUFDRCxTQUFTLEVBQUUsQ0FBQyxXQUFXLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUM7WUFDbkcsU0FBUyxFQUFFO2dCQUNQLGFBQWEsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7YUFDcEQ7WUFDRCxPQUFPLEVBQUU7Z0JBQ0wsU0FBUyxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUU7YUFDcEM7U0FDSixDQUFDO1FBRU0saUJBQVksR0FBYSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3pELG9CQUFlLEdBQUcsV0FBVyxDQUFDO1FBSzlCLGNBQVMsR0FBVyxJQUFJLENBQUM7O1FBOENqQyxhQUFRLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN0QixjQUFTLEdBQUcsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDOztjQTNDWixPQUFPLEdBQVEsRUFBRSxDQUFDLGFBQWE7UUFFckMsd0NBQXdDO1FBQ3hDLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ2pFLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1NBQzlCO1FBRUQsZ0NBQWdDO1FBQ2hDLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxtQkFBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUEsQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7Ozs7O0lBbkVELElBQWEsYUFBYSxDQUFDLE9BQVk7UUFDbkMsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3pEO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDMUQsQ0FBQzs7Ozs7O0lBRUQsSUFBYSxlQUFlLENBQUMsT0FBWTtRQUNyQyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9CLENBQUM7Ozs7SUE0REQsUUFBUTtRQUNKLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFBO1FBQ3JCLDRFQUE0RTtRQUM1RSxvRkFBb0Y7UUFDcEYsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRTtZQUN2QyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7U0FDdkI7YUFBTTtZQUNILGdDQUFnQztZQUNoQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztTQUNuQztJQUNMLENBQUM7Ozs7O0lBRUQsV0FBVyxDQUFDLE9BQU87UUFDZixJQUFJLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxPQUFPLEVBQUU7WUFDcEMsSUFBSSxPQUFPLENBQUMscUJBQXFCLElBQUksQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsV0FBVztnQkFDM0UsT0FBTyxDQUFDLHFCQUFxQixDQUFDLFlBQVksS0FBSyxPQUFPLENBQUMscUJBQXFCLENBQUMsYUFBYSxFQUFFO2dCQUM1RixJQUFJLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZLEVBQUU7b0JBQzVDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUN4QztxQkFBTTtvQkFDSCxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDdkM7YUFDSjtTQUNKO0lBQ0wsQ0FBQzs7OztJQUVELFdBQVc7UUFDUCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDekIsQ0FBQzs7Ozs7O0lBT0QsVUFBVSxDQUFDLE9BQVk7UUFDbkIsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMvQixDQUFDOzs7OztJQUVELGdCQUFnQixDQUFDLEVBQW9CLElBQVUsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDOzs7OztJQUNwRSxpQkFBaUIsQ0FBQyxFQUFjLElBQVUsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDOzs7Ozs7O0lBR3hELFlBQVksQ0FBQyxPQUFZO1FBQzdCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1RCxPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU3QixJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUN6QixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDOUM7YUFBTTtZQUNILElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2hDO0lBQ0wsQ0FBQzs7Ozs7OztJQUdPLFdBQVcsQ0FBQyxPQUFhO1FBQzdCLHVDQUF1QztRQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7O2dCQUNYLFlBQVksR0FBUSxJQUFJO1lBRTVCLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTs7c0JBQ2YsY0FBYyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVTs7c0JBQzdDLEtBQUssR0FBRyxFQUFFO2dCQUVoQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsY0FBYyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTs7MEJBQ3RDLFFBQVEsR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtvQkFDdkMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO3dCQUMvRixTQUFTO3FCQUNaO29CQUNELEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO2lCQUM3QztnQkFFRCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFO29CQUM3QixLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO2lCQUM3RDtnQkFFRCxZQUFZLEdBQUcsS0FBSyxDQUFDO2FBQ3hCO2lCQUFNOztzQkFDRyxZQUFZLEdBQVEsT0FBTyxJQUFJLEVBQUU7Z0JBQ3ZDLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxFQUFFO29CQUNsQyxZQUFZLEdBQUcsWUFBWSxDQUFDO2lCQUMvQjthQUNKO1lBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxZQUFZLENBQUM7WUFDOUIseUJBQXlCO1lBQ3pCLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDOUMscUJBQXFCO1lBQ3JCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOzs7OztJQUVPLGFBQWE7O2NBQ1gsSUFBSSxHQUFHLElBQUk7UUFFakIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFBRSxPQUFPO1NBQUU7UUFFaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLEVBQUU7WUFDakMsVUFBVSxDQUFDO2dCQUNQLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN2QixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDVixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLG1CQUFtQixFQUFFLFVBQVUsS0FBSyxFQUFFLFFBQVEsRUFBRSxTQUFTO1lBQ3ZFLFVBQVUsQ0FBQztnQkFDUCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQy9CLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNWLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLEVBQUU7WUFDakMsVUFBVSxDQUFDO2dCQUNQLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNyQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDVixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQywyQkFBMkIsRUFBRTtZQUMzQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUU7Z0JBQ3JCLFVBQVUsQ0FBQztvQkFDUCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3ZCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNWLENBQUMsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDOzs7OztJQUVPLFlBQVk7UUFDaEIsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDekIsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUd0QixzQ0FBc0M7UUFFdEMsY0FBYztRQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFO1lBQzdCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDakYsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsWUFBWTtZQUNsQyxJQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtnQkFDNUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDeEM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7SUFDbkMsQ0FBQzs7Ozs7SUFFTyxPQUFPO1FBQ1gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQy9ELENBQUM7Ozs7OztJQUVPLFVBQVUsQ0FBQyxTQUFTLEdBQUcsS0FBSzs7O2NBRTFCLElBQUksR0FBRyxJQUFJO1FBQ2pCLHNCQUFzQjtRQUN0QixJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQzdCLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTs7c0JBQ2YsSUFBSSxHQUFXLElBQUksQ0FBQyxNQUFNO2dCQUNoQyxzQkFBc0I7Z0JBQ3RCLElBQUksSUFBSSxFQUFFO29CQUVOLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxFQUFFO3dCQUNyQixJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxLQUFLLElBQUksQ0FBQyxlQUFlLEVBQUU7NEJBQzVELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzt5QkFDekM7cUJBQ0o7b0JBRUQsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRTt3QkFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztxQkFDNUQ7aUJBQ0o7YUFDSjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7YUFDbEI7U0FDSjtJQUNMLENBQUM7Ozs7O0lBRU8sYUFBYTtRQUNqQixJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUN6QixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMxQixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGdDQUFnQztZQUN0RSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO1NBQ25DO0lBQ0wsQ0FBQzs7Ozs7SUFFTyxTQUFTO1FBQ2IsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6RDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Ozs7Ozs7SUFJTyx3QkFBd0I7O2NBQ3RCLFFBQVEsR0FBRztZQUNiLFVBQVUsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDeEMsT0FBTyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUN0QyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3ZDO1FBQ0QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkMsQ0FBQzs7Ozs7O0lBRWEsV0FBVyxDQUFDLEtBQUs7OztrQkFDckIsSUFBSSxHQUFHLElBQUksUUFBUSxFQUFFO1lBQzNCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0IsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsRUFBRTtnQkFDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDO3FCQUM5QyxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsUUFBMEIsRUFBRSxFQUFFLENBQUMsUUFBUSxJQUFJLE9BQU8sUUFBUSxDQUFDLElBQUksS0FBSyxRQUFRLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxFQUNuRyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ1gsVUFBVSxDQUFDLGtDQUFrQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNuRCxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDbEIsQ0FBQyxDQUFDLENBQUM7cUJBQ04sU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUNoQixJQUFJLE1BQU0sRUFBRTt3QkFDUixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLENBQUM7d0JBQ2pELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7cUJBQy9DO3lCQUFNO3dCQUNILElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztxQkFDakM7Z0JBQ0wsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7b0JBQ0wsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNsQyxDQUFDLENBQUMsQ0FBQzthQUNWO2lCQUFNO2dCQUNILElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNqQztRQUNMLENBQUM7S0FBQTs7Ozs7SUFFRCxpQkFBaUIsQ0FBQyxLQUFLOztjQUNiLE1BQU0sR0FBRyxJQUFJLFVBQVUsRUFBRTtRQUMvQixNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3BFLENBQUMsQ0FBQztRQUNGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25ELENBQUM7Ozs7O0lBR08sZUFBZTtRQUNuQixPQUFPLFVBQVUsT0FBTzs7a0JBQ2QsRUFBRSxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsRUFBRTs7O2tCQUVwQixNQUFNLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQztnQkFDckIsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLE9BQU8sRUFBRSxjQUFjO2dCQUN2QixLQUFLLEVBQUU7O3dCQUNDLFlBQVksR0FBRyxJQUFJO29CQUN2Qiw2RUFBNkU7b0JBQzdFLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRTt3QkFDckIsWUFBWSxHQUFHLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO3FCQUM3RTs7MEJBQ0ssUUFBUSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyx1QkFBdUI7OzBCQUNoRSxTQUFTLEdBQUcseVhBQXlYLFFBQVEsZUFBZTtvQkFFbGEsT0FBTyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDbEQsQ0FBQzthQUNKLENBQUM7WUFFRixPQUFPLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFHLGlDQUFpQztRQUMvRCxDQUFDLENBQUE7SUFDTCxDQUFDOzs7WUExVkosU0FBUyxTQUFDOztnQkFFUCxRQUFRLEVBQUUsaUJBQWlCO2dCQUMzQixTQUFTLEVBQUUsQ0FBQzt3QkFDUixPQUFPLEVBQUUsaUJBQWlCO3dCQUMxQixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLHNCQUFzQixDQUFDO3dCQUNyRCxLQUFLLEVBQUUsSUFBSTtxQkFDZCxDQUFDO2FBQ0w7Ozs7WUF4QkcsVUFBVTtZQUlWLE1BQU07WUFQRCxVQUFVOzs7NEJBNkJkLEtBQUs7OEJBT0wsS0FBSztvQ0FLTCxNQUFNOzBCQUNOLE1BQU07NkJBR04sTUFBTTttQkFFTixNQUFNO29DQUVOLEtBQUs7Ozs7SUFSTix1REFBNkU7O0lBQzdFLDZDQUFtRTs7SUFHbkUsZ0RBQTRFOztJQUU1RSxzQ0FBNEQ7O0lBRTVELHVEQUF3Qzs7Ozs7SUFFeEMsMENBdUJFOzs7OztJQUVGLDhDQUFpRTs7Ozs7SUFDakUsaURBQXNDOzs7OztJQUN0QyxnREFBZ0M7Ozs7O0lBQ2hDLDJDQUF1Qjs7Ozs7SUFDdkIseUNBQXFCOzs7OztJQUNyQix3Q0FBdUI7Ozs7O0lBQ3ZCLDJDQUFpQzs7Ozs7SUFDakMsb0RBQW9DOztJQTZDcEMsMENBQXNCOztJQUN0QiwyQ0FBc0I7Ozs7O0lBNUNNLHNDQUFvQjs7Ozs7SUFBRSxzQ0FBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtcbiAgICBEaXJlY3RpdmUsXG4gICAgRWxlbWVudFJlZixcbiAgICBFdmVudEVtaXR0ZXIsXG4gICAgZm9yd2FyZFJlZixcbiAgICBJbnB1dCxcbiAgICBOZ1pvbmUsXG4gICAgT25DaGFuZ2VzLFxuICAgIE9uRGVzdHJveSxcbiAgICBPbkluaXQsXG4gICAgT3V0cHV0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmRlY2xhcmUgdmFyICQ7XG5cbkBEaXJlY3RpdmUoe1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3JcbiAgICBzZWxlY3RvcjogJ1tuZ3hTdW1tZXJub3RlXScsXG4gICAgcHJvdmlkZXJzOiBbe1xuICAgICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gTmd4U3VtbWVybm90ZURpcmVjdGl2ZSksXG4gICAgICAgIG11bHRpOiB0cnVlXG4gICAgfV1cbn0pXG5leHBvcnQgY2xhc3MgTmd4U3VtbWVybm90ZURpcmVjdGl2ZSBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBPbkluaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcbiAgICBASW5wdXQoKSBzZXQgbmd4U3VtbWVybm90ZShvcHRpb25zOiBhbnkpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuYnV0dG9ucykge1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihvcHRpb25zLmJ1dHRvbnMsIHRoaXMuX29wdGlvbnMuYnV0dG9ucyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24odGhpcy5fb3B0aW9ucywgb3B0aW9ucyk7XG4gICAgfVxuICAgIC8vIHN1bW1lcm5vdGVNb2RlbCBkaXJlY3RpdmUgYXMgaW5wdXQ6IHN0b3JlIGluaXRpYWwgZWRpdG9yIGNvbnRlbnRcbiAgICBASW5wdXQoKSBzZXQgc3VtbWVybm90ZU1vZGVsKGNvbnRlbnQ6IGFueSkge1xuICAgICAgICB0aGlzLnVwZGF0ZUVkaXRvcihjb250ZW50KTtcbiAgICB9XG5cbiAgICAvLyBzdW1tZXJub3RlTW9kZWwgZGlyZWN0aXZlIGFzIG91dHB1dDogdXBkYXRlIG1vZGVsIGlmIGVkaXRvciBjb250ZW50Q2hhbmdlZFxuICAgIEBPdXRwdXQoKSBzdW1tZXJub3RlTW9kZWxDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gICAgQE91dHB1dCgpIGltYWdlVXBsb2FkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgLy8gc3VtbWVybm90ZUluaXQgZGlyZWN0aXZlIGFzIG91dHB1dDogc2VuZCBtYW51YWwgZWRpdG9yIGluaXRpYWxpemF0aW9uXG4gICAgQE91dHB1dCgpIHN1bW1lcm5vdGVJbml0OiBFdmVudEVtaXR0ZXI8T2JqZWN0PiA9IG5ldyBFdmVudEVtaXR0ZXI8T2JqZWN0PigpO1xuXG4gICAgQE91dHB1dCgpIGJsdXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICBASW5wdXQoKSBuZ3hTdW1tZXJub3RlRGlzYWJsZWQ6IGJvb2xlYW47XG5cbiAgICBwcml2YXRlIF9vcHRpb25zOiBhbnkgPSB7XG4gICAgICAgIGltbWVkaWF0ZUFuZ3VsYXJNb2RlbFVwZGF0ZTogZmFsc2UsXG4gICAgICAgIGFuZ3VsYXJJZ25vcmVBdHRyczogbnVsbCxcbiAgICAgICAgcGxhY2Vob2xkZXI6ICcnLFxuICAgICAgICB0YWJzaXplOiAyLFxuICAgICAgICBoZWlnaHQ6IDEwMCxcbiAgICAgICAgdXBsb2FkSW1hZ2VQYXRoOiAnJyxcbiAgICAgICAgdG9vbGJhcjogW1xuICAgICAgICAgICAgLy8gW2dyb3VwTmFtZSwgW2xpc3Qgb2YgYnV0dG9uXV1cbiAgICAgICAgICAgIFsnbWlzYycsIFsnY29kZXZpZXcnLCAndW5kbycsICdyZWRvJywgJ2NvZGVCbG9jayddXSxcbiAgICAgICAgICAgIC8vIFsnc3R5bGUnLCBbJ2JvbGQnLCAnaXRhbGljJywgJ3VuZGVybGluZScsICdjbGVhciddXSxcbiAgICAgICAgICAgIFsnZm9udCcsIFsnYm9sZCcsICdpdGFsaWMnLCAndW5kZXJsaW5lJywgJ3N0cmlrZXRocm91Z2gnLCAnc3VwZXJzY3JpcHQnLCAnc3Vic2NyaXB0JywgJ2NsZWFyJ11dLFxuICAgICAgICAgICAgWydmb250c2l6ZScsIFsnZm9udG5hbWUnLCAnZm9udHNpemUnLCAnY29sb3InXV0sXG4gICAgICAgICAgICBbJ3BhcmEnLCBbJ3N0eWxlMCcsICd1bCcsICdvbCcsICdwYXJhZ3JhcGgnLCAnaGVpZ2h0J11dLFxuICAgICAgICAgICAgWydpbnNlcnQnLCBbJ3RhYmxlJywgJ3BpY3R1cmUnLCAnbGluaycsICd2aWRlbycsICdociddXSxcbiAgICAgICAgXSxcbiAgICAgICAgZm9udE5hbWVzOiBbJ0hlbHZldGljYScsICdBcmlhbCcsICdBcmlhbCBCbGFjaycsICdDb21pYyBTYW5zIE1TJywgJ0NvdXJpZXIgTmV3JywgJ1JvYm90bycsICdUaW1lcyddLFxuICAgICAgICBjYWxsYmFja3M6IHtcbiAgICAgICAgICAgIG9uSW1hZ2VVcGxvYWQ6IChmaWxlcykgPT4gdGhpcy51cGxvYWRJbWFnZShmaWxlcylcbiAgICAgICAgfSxcbiAgICAgICAgYnV0dG9uczoge1xuICAgICAgICAgICAgY29kZUJsb2NrOiB0aGlzLmNvZGVCbG9ja0J1dHRvbigpXG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBTUEVDSUFMX1RBR1M6IHN0cmluZ1tdID0gWydpbWcnLCAnYnV0dG9uJywgJ2lucHV0JywgJ2EnXTtcbiAgICBwcml2YXRlIElOTkVSX0hUTUxfQVRUUiA9ICdpbm5lckhUTUwnO1xuICAgIHByaXZhdGUgX2hhc1NwZWNpYWxUYWc6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfJGVsZW1lbnQ6IGFueTsgLy8ganF1ZXJ5IHdyYXBwZWQgZWxlbWVudFxuICAgIHByaXZhdGUgX2VkaXRvcjogYW55OyAvLyBlZGl0b3IgZWxlbWVudFxuICAgIHByaXZhdGUgX21vZGVsOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfb2xkTW9kZWw6IHN0cmluZyA9IG51bGw7XG4gICAgcHJpdmF0ZSBfZWRpdG9ySW5pdGlhbGl6ZWQ6IGJvb2xlYW47XG5cbiAgICBjb25zdHJ1Y3RvcihlbDogRWxlbWVudFJlZiwgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge1xuICAgICAgICBjb25zdCBlbGVtZW50OiBhbnkgPSBlbC5uYXRpdmVFbGVtZW50O1xuXG4gICAgICAgIC8vIGNoZWNrIGlmIHRoZSBlbGVtZW50IGlzIGEgc3BlY2lhbCB0YWdcbiAgICAgICAgaWYgKHRoaXMuU1BFQ0lBTF9UQUdTLmluZGV4T2YoZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkpICE9PSAtMSkge1xuICAgICAgICAgICAgdGhpcy5faGFzU3BlY2lhbFRhZyA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBqcXVlcnkgd3JhcCBhbmQgc3RvcmUgZWxlbWVudFxuICAgICAgICB0aGlzLl8kZWxlbWVudCA9ICg8YW55PiQoZWxlbWVudCkpO1xuICAgICAgICB0aGlzLnpvbmUgPSB6b25lO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLl9vcHRpb25zLnRvb2xiYXJcbiAgICAgICAgLy8gY2hlY2sgaWYgb3V0cHV0IHN1bW1lcm5vdGVJbml0IGlzIHByZXNlbnQuIE1heWJlIG9ic2VydmVycyBpcyBwcml2YXRlIGFuZFxuICAgICAgICAvLyBzaG91bGQgbm90IGJlIHVzZWQ/PyBUT0RPIGhvdyB0byBiZXR0ZXIgdGVzdCB0aGF0IGFuIG91dHB1dCBkaXJlY3RpdmUgaXMgcHJlc2VudC5cbiAgICAgICAgaWYgKCF0aGlzLnN1bW1lcm5vdGVJbml0Lm9ic2VydmVycy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlRWRpdG9yKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBUT0RPIG5vdCBzdXJlIGl0IHdvcmtzIG5vdy4uLlxuICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU1hbnVhbENvbnRyb2xsZXIoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXMpIHtcbiAgICAgICAgaWYgKHRoaXMuX2VkaXRvckluaXRpYWxpemVkICYmIGNoYW5nZXMpIHtcbiAgICAgICAgICAgIGlmIChjaGFuZ2VzLm5neFN1bW1lcm5vdGVEaXNhYmxlZCAmJiAhY2hhbmdlcy5uZ3hTdW1tZXJub3RlRGlzYWJsZWQuZmlyc3RDaGFuZ2UgJiZcbiAgICAgICAgICAgICAgICBjaGFuZ2VzLm5neFN1bW1lcm5vdGVEaXNhYmxlZC5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMubmd4U3VtbWVybm90ZURpc2FibGVkLnByZXZpb3VzVmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2hhbmdlcy5uZ3hTdW1tZXJub3RlRGlzYWJsZWQuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUoJ2Rpc2FibGUnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl8kZWxlbWVudC5zdW1tZXJub3RlKCdlbmFibGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5kZXN0cm95RWRpdG9yKCk7XG4gICAgfVxuXG4gICAgLy8gQmVnaW4gQ29udHJvbFZhbHVlQWNjZXNvciBtZXRob2RzLlxuICAgIG9uQ2hhbmdlID0gKF8pID0+IHsgfTtcbiAgICBvblRvdWNoZWQgPSAoKSA9PiB7IH07XG5cbiAgICAvLyBGb3JtIG1vZGVsIGNvbnRlbnQgY2hhbmdlZC5cbiAgICB3cml0ZVZhbHVlKGNvbnRlbnQ6IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLnVwZGF0ZUVkaXRvcihjb250ZW50KTtcbiAgICB9XG5cbiAgICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAoXzogYW55KSA9PiB2b2lkKTogdm9pZCB7IHRoaXMub25DaGFuZ2UgPSBmbjsgfVxuICAgIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB2b2lkKTogdm9pZCB7IHRoaXMub25Ub3VjaGVkID0gZm47IH1cblxuICAgIC8vIFVwZGF0ZSBlZGl0b3Igd2l0aCBtb2RlbCBjb250ZW50cy5cbiAgICBwcml2YXRlIHVwZGF0ZUVkaXRvcihjb250ZW50OiBhbnkpIHtcbiAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KHRoaXMuX29sZE1vZGVsKSA9PT0gSlNPTi5zdHJpbmdpZnkoY29udGVudCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX29sZE1vZGVsID0gY29udGVudDtcbiAgICAgICAgdGhpcy5fJGVsZW1lbnQuaHRtbChjb250ZW50KTtcblxuICAgICAgICBpZiAodGhpcy5fZWRpdG9ySW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUoJ2NvZGUnLCBjb250ZW50KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuXyRlbGVtZW50Lmh0bWwoY29udGVudCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB1cGRhdGUgbW9kZWwgaWYgZWRpdG9yIGNvbnRlbnRDaGFuZ2VkXG4gICAgcHJpdmF0ZSB1cGRhdGVNb2RlbChjb250ZW50PzogYW55KSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwidXBkYXRlIG1vZGVsXCIsIGNvbnRlbnQpXG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgbGV0IG1vZGVsQ29udGVudDogYW55ID0gbnVsbDtcblxuICAgICAgICAgICAgaWYgKHRoaXMuX2hhc1NwZWNpYWxUYWcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVOb2RlcyA9IHRoaXMuXyRlbGVtZW50WzBdLmF0dHJpYnV0ZXM7XG4gICAgICAgICAgICAgICAgY29uc3QgYXR0cnMgPSB7fTtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXR0cmlidXRlTm9kZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0ck5hbWUgPSBhdHRyaWJ1dGVOb2Rlc1tpXS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fb3B0aW9ucy5hbmd1bGFySWdub3JlQXR0cnMgJiYgdGhpcy5fb3B0aW9ucy5hbmd1bGFySWdub3JlQXR0cnMuaW5kZXhPZihhdHRyTmFtZSkgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhdHRyc1thdHRyTmFtZV0gPSBhdHRyaWJ1dGVOb2Rlc1tpXS52YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fJGVsZW1lbnRbMF0uaW5uZXJIVE1MKSB7XG4gICAgICAgICAgICAgICAgICAgIGF0dHJzW3RoaXMuSU5ORVJfSFRNTF9BVFRSXSA9IHRoaXMuXyRlbGVtZW50WzBdLmlubmVySFRNTDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBtb2RlbENvbnRlbnQgPSBhdHRycztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmV0dXJuZWRIdG1sOiBhbnkgPSBjb250ZW50IHx8ICcnO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0dXJuZWRIdG1sID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICBtb2RlbENvbnRlbnQgPSByZXR1cm5lZEh0bWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fb2xkTW9kZWwgPSBtb2RlbENvbnRlbnQ7XG4gICAgICAgICAgICAvLyBVcGRhdGUgc3VtbWVybm90ZU1vZGVsXG4gICAgICAgICAgICB0aGlzLnN1bW1lcm5vdGVNb2RlbENoYW5nZS5lbWl0KG1vZGVsQ29udGVudCk7XG4gICAgICAgICAgICAvLyBVcGRhdGUgZm9ybSBtb2RlbC5cbiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoY29udGVudCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdExpc3RlbmVycygpIHtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgaWYgKCF0aGlzLl8kZWxlbWVudCkgeyByZXR1cm47IH1cblxuICAgICAgICB0aGlzLl8kZWxlbWVudC5vbignc3VtbWVybm90ZS5pbml0JywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgc2VsZi51cGRhdGVNb2RlbCgpO1xuICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuXyRlbGVtZW50Lm9uKCdzdW1tZXJub3RlLmNoYW5nZScsIGZ1bmN0aW9uIChldmVudCwgY29udGVudHMsICRlZGl0YWJsZSkge1xuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgc2VsZi51cGRhdGVNb2RlbChjb250ZW50cyk7XG4gICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fJGVsZW1lbnQub24oJ3N1bW1lcm5vdGUuYmx1cicsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHNlbGYub25Ub3VjaGVkKCk7XG4gICAgICAgICAgICAgICAgc2VsZi5ibHVyLmVtaXQoKTtcbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5fb3B0aW9ucy5pbW1lZGlhdGVBbmd1bGFyTW9kZWxVcGRhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuX2VkaXRvci5vbigna2V5dXAnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlTW9kZWwoKTtcbiAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVFZGl0b3IoKSB7XG4gICAgICAgIGlmICh0aGlzLl9lZGl0b3JJbml0aWFsaXplZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRDb250ZW50KHRydWUpO1xuXG4gICAgICAgIFxuICAgICAgICAvLyB0aGlzLmluaXRMaXN0ZW5lcnMoKTsgLy8gaXNzdWUgIzMxIFxuXG4gICAgICAgIC8vIGluaXQgZWRpdG9yXG4gICAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9lZGl0b3IgPSB0aGlzLl8kZWxlbWVudC5zdW1tZXJub3RlKHRoaXMuX29wdGlvbnMpLmRhdGEoJ3N1bW1lcm5vdGUnKS4kbm90ZTtcbiAgICAgICAgICAgIHRoaXMuaW5pdExpc3RlbmVycygpOyAvLyBpc3N1ZSAjMzFcbiAgICAgICAgICAgIGlmICh0aGlzLm5neFN1bW1lcm5vdGVEaXNhYmxlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUoJ2Rpc2FibGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fZWRpdG9ySW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0SHRtbCgpIHtcbiAgICAgICAgdGhpcy5fJGVsZW1lbnQuc3VtbWVybm90ZSgnY29kZScsIHRoaXMuX21vZGVsIHx8ICcnLCB0cnVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldENvbnRlbnQoZmlyc3RUaW1lID0gZmFsc2UpIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJzZXQgY29udGVudFwiLCBmaXJzdFRpbWUsIHRoaXMuX29sZE1vZGVsLCB0aGlzLl9tb2RlbClcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIC8vIFNldCBpbml0aWFsIGNvbnRlbnRcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsIHx8IHRoaXMuX21vZGVsID09PSAnJykge1xuICAgICAgICAgICAgdGhpcy5fb2xkTW9kZWwgPSB0aGlzLl9tb2RlbDtcbiAgICAgICAgICAgIGlmICh0aGlzLl9oYXNTcGVjaWFsVGFnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGFnczogT2JqZWN0ID0gdGhpcy5fbW9kZWw7XG4gICAgICAgICAgICAgICAgLy8gYWRkIHRhZ3Mgb24gZWxlbWVudFxuICAgICAgICAgICAgICAgIGlmICh0YWdzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBhdHRyIGluIHRhZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmhhc093blByb3BlcnR5KGF0dHIpICYmIGF0dHIgIT09IHRoaXMuSU5ORVJfSFRNTF9BVFRSKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fJGVsZW1lbnQuYXR0cihhdHRyLCB0YWdzW2F0dHJdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmhhc093blByb3BlcnR5KHRoaXMuSU5ORVJfSFRNTF9BVFRSKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fJGVsZW1lbnRbMF0uaW5uZXJIVE1MID0gdGFnc1t0aGlzLklOTkVSX0hUTUxfQVRUUl07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNlbGYuc2V0SHRtbCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZXN0cm95RWRpdG9yKCkge1xuICAgICAgICBpZiAodGhpcy5fZWRpdG9ySW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2VkaXRvci5vZmYoJ2tleXVwJyk7XG4gICAgICAgICAgICB0aGlzLl8kZWxlbWVudC5zdW1tZXJub3RlKCdkZXN0cm95Jyk7IC8vIFRPRE8gbm90IHN1cmUgaXQgd29ya3Mgbm93Li4uXG4gICAgICAgICAgICB0aGlzLl9lZGl0b3JJbml0aWFsaXplZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRFZGl0b3IoKSB7XG4gICAgICAgIGlmICh0aGlzLl8kZWxlbWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUuYmluZCh0aGlzLl8kZWxlbWVudCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBzZW5kIG1hbnVhbCBlZGl0b3IgaW5pdGlhbGl6YXRpb25cbiAgICAvLyBUT0RPIG5vdCBzdXJlIGl0IHdvcmtzIG5vdy4uLlxuICAgIHByaXZhdGUgZ2VuZXJhdGVNYW51YWxDb250cm9sbGVyKCkge1xuICAgICAgICBjb25zdCBjb250cm9scyA9IHtcbiAgICAgICAgICAgIGluaXRpYWxpemU6IHRoaXMuY3JlYXRlRWRpdG9yLmJpbmQodGhpcyksXG4gICAgICAgICAgICBkZXN0cm95OiB0aGlzLmRlc3Ryb3lFZGl0b3IuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIGdldEVkaXRvcjogdGhpcy5nZXRFZGl0b3IuYmluZCh0aGlzKSxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zdW1tZXJub3RlSW5pdC5lbWl0KGNvbnRyb2xzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHVwbG9hZEltYWdlKGZpbGVzKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgdGhpcy5pbWFnZVVwbG9hZC5lbWl0KHsgdXBsb2FkaW5nOiB0cnVlIH0pO1xuICAgICAgICBkYXRhLmFwcGVuZCgnaW1hZ2UnLCBmaWxlc1swXSk7XG4gICAgICAgIGlmICh0aGlzLl9vcHRpb25zLnVwbG9hZEltYWdlUGF0aCkge1xuICAgICAgICAgICAgdGhpcy5odHRwLnBvc3QodGhpcy5fb3B0aW9ucy51cGxvYWRJbWFnZVBhdGgsIGRhdGEpXG4gICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IHsgcGF0aDogc3RyaW5nIH0pID0+IHJlc3BvbnNlICYmIHR5cGVvZiByZXNwb25zZS5wYXRoID09PSAnc3RyaW5nJyAmJiByZXNwb25zZS5wYXRoKSxcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcihlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoJ0FuIGVycm9yIG9jY3VyZWQgd2hpbGUgdXBsb2FkaW5nJyArIGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShkYXRhSW4gPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YUluKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl8kZWxlbWVudC5zdW1tZXJub3RlKCdpbnNlcnRJbWFnZScsIGRhdGFJbik7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltYWdlVXBsb2FkLmVtaXQoeyB1cGxvYWRpbmc6IGZhbHNlIH0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRGcm9tRGF0YVVSTChmaWxlcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluc2VydEZyb21EYXRhVVJMKGZpbGVzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuaW5zZXJ0RnJvbURhdGFVUkwoZmlsZXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaW5zZXJ0RnJvbURhdGFVUkwoZmlsZXMpIHtcbiAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZXNbMF0pO1xuICAgICAgICByZWFkZXIub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fJGVsZW1lbnQuc3VtbWVybm90ZSgnaW5zZXJ0SW1hZ2UnLCByZWFkZXIucmVzdWx0KTtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VVcGxvYWQuZW1pdCh7IHVwbG9hZGluZzogZmFsc2UsIGVuY29kaW5nOiAnYmFzZTY0JyB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSBlcnJvciA9PiBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICB9XG5cblxuICAgIHByaXZhdGUgY29kZUJsb2NrQnV0dG9uKCkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgICAgICAgICAgIGNvbnN0IHVpID0gJC5zdW1tZXJub3RlLnVpO1xuICAgICAgICAgICAgLy8gY3JlYXRlIGJ1dHRvblxuICAgICAgICAgICAgY29uc3QgYnV0dG9uID0gdWkuYnV0dG9uKHtcbiAgICAgICAgICAgICAgICBjb250ZW50czogJ0NvZGUgYmxvY2snLFxuICAgICAgICAgICAgICAgIHRvb2x0aXA6ICdBZGQgcmF3IGNvZGUnLFxuICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzZWxlY3RlZFRleHQgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAvLyBUaGUgYmVsb3cgY29kZSB3aWxsIGNvcHkgdGhlIHNlbGVjdGVkIGJsb2NrIGFuZCBhZGQgaXQgaW50byBvdXIgY29kZT1ibG9ja1xuICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmdldFNlbGVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUZXh0ID0gd2luZG93LmdldFNlbGVjdGlvbigpLnRvU3RyaW5nKCkucmVwbGFjZSgvXlxccyt8XFxzKyQvZywgJycpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvZGVUZXh0ID0gc2VsZWN0ZWRUZXh0ID8gc2VsZWN0ZWRUZXh0IDogYFBsYWNlIHlvdXIgY29kZSBoZXJlLmA7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvZGVCbG9jayA9IGA8cHJlIGNsYXNzPVwiY29kZS1ibG9ja1wiIHN0eWxlPVwiZm9udC1mYW1pbHk6IE1lbmxvLCBNb25hY28sIENvbnNvbGFzLCAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7IGZvbnQtc2l6ZTogMTJweDsgcGFkZGluZzogMTRweCAxMnB4OyBtYXJnaW4tYm90dG9tOiAxMHB4OyBsaW5lLWhlaWdodDogMS40Mjg1Nzsgd29yZC1icmVhazogYnJlYWstYWxsOyBvdmVyZmxvdy13cmFwOiBicmVhay13b3JkOyBiYWNrZ3JvdW5kLWNvbG9yOiByZ2IoMjUwLCAyNTEsIDI1Myk7IGJvcmRlcjogMXB4IHNvbGlkIHJnYigyMzQsIDIzNiwgMjQwKTsgYm9yZGVyLXJhZGl1czogNHB4OyBjb2xvcjogIzYwYTBiMFwiPjxzcGFuIHN0eWxlPVwid2hpdGUtc3BhY2U6IHByZS13cmFwO1wiPiR7Y29kZVRleHR9PC9zcGFuPjwvcHJlPmA7XG5cbiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5pbnZva2UoJ2VkaXRvci5wYXN0ZUhUTUwnLCBjb2RlQmxvY2spO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gYnV0dG9uLnJlbmRlcigpOyAgIC8vIHJldHVybiBidXR0b24gYXMganF1ZXJ5IG9iamVjdFxuICAgICAgICB9XG4gICAgfVxufVxuIl19